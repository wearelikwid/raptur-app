name: Build Raptur for macOS

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Homebrew dependencies
      run: |
        brew install ffmpeg rubberband
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Prepare native binaries for bundling
      run: |
        mkdir -p native_bins
        mkdir -p native_libs
        
        # Copy main binaries
        cp $(brew --prefix)/bin/ffmpeg native_bins/
        cp $(brew --prefix)/bin/ffprobe native_bins/
        cp $(brew --prefix)/bin/rubberband native_bins/
        
        # Copy audio libraries
        cp $(brew --prefix)/lib/librubberband*.dylib native_libs/ 2>/dev/null || true
        cp $(brew --prefix)/lib/libsndfile*.dylib native_libs/ 2>/dev/null || true
        cp $(brew --prefix)/lib/libsamplerate*.dylib native_libs/ 2>/dev/null || true
        cp $(brew --prefix)/lib/libFLAC*.dylib native_libs/ 2>/dev/null || true
        cp $(brew --prefix)/lib/libogg*.dylib native_libs/ 2>/dev/null || true
        cp $(brew --prefix)/lib/libvorbis*.dylib native_libs/ 2>/dev/null || true
        cp $(brew --prefix)/lib/libopus*.dylib native_libs/ 2>/dev/null || true
        cp $(brew --prefix)/lib/libmp3lame*.dylib native_libs/ 2>/dev/null || true
        
        # Copy dependencies of native binaries
        for bin in native_bins/*; do
          for lib in $(otool -L "$bin" | grep -E '/opt/homebrew|/usr/local' | awk '{print $1}'); do
            if [ -f "$lib" ]; then
              cp -n "$lib" native_libs/ 2>/dev/null || true
            fi
          done
        done
        
        echo "Native binaries prepared:"
        ls -la native_bins/
        echo "Native libraries:"
        ls -la native_libs/ || echo "No native libs found"
    
    - name: Build macOS app with PyInstaller
      run: |
        # Build using spec file plus native binaries
        pyinstaller raptur.spec \
          --add-binary "native_bins/ffmpeg:." \
          --add-binary "native_bins/ffprobe:." \
          --add-binary "native_bins/rubberband:."
        
        # Copy native libs to the app bundle
        if [ -d "native_libs" ] && [ "$(ls -A native_libs)" ]; then
          cp native_libs/*.dylib dist/Raptur.app/Contents/MacOS/ 2>/dev/null || true
          mkdir -p dist/Raptur.app/Contents/Frameworks
          cp native_libs/*.dylib dist/Raptur.app/Contents/Frameworks/ 2>/dev/null || true
        fi
    
    - name: Ad-hoc code sign the app
      run: |
        # Remove any existing signatures
        codesign --remove-signature dist/Raptur.app 2>/dev/null || true
        
        # Sign all dylibs and binaries inside the app
        find dist/Raptur.app -name "*.dylib" -exec codesign --force --sign - {} \; 2>/dev/null || true
        find dist/Raptur.app -name "*.so" -exec codesign --force --sign - {} \; 2>/dev/null || true
        find dist/Raptur.app/Contents/MacOS -type f -perm +111 -exec codesign --force --sign - {} \; 2>/dev/null || true
        
        # Sign the main app bundle
        codesign --force --deep --sign - dist/Raptur.app
        
        echo "Code signing complete"
    
    - name: Create distribution zip
      run: |
        cd dist
        zip -r Raptur-macOS.zip Raptur.app
        mv Raptur-macOS.zip ../
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: Raptur-macOS
        path: Raptur-macOS.zip
        retention-days: 30
