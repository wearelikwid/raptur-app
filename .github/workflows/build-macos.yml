name: Build Raptur for macOS

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Homebrew dependencies
      run: |
        brew install rubberband
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller>=6.17.0
    
    - name: Download static ffmpeg binary
      run: |
        echo "=== Downloading static ffmpeg ==="
        mkdir -p native_bins
        
        # Detect architecture
        ARCH=$(uname -m)
        echo "Detected architecture: $ARCH"
        
        if [ "$ARCH" = "arm64" ]; then
          echo "Downloading ARM64 ffmpeg from martin-riedl.de..."
          FFMPEG_URL="https://ffmpeg.martin-riedl.de/redirect/latest/macos/arm64/snapshot/ffmpeg.zip"
        else
          echo "Downloading Intel x86_64 ffmpeg from evermeet.cx..."
          FFMPEG_URL="https://evermeet.cx/ffmpeg/get/zip"
        fi
        
        # Download and extract
        cd native_bins
        curl -JL -o ffmpeg.zip "$FFMPEG_URL"
        unzip -o ffmpeg.zip
        rm ffmpeg.zip
        
        # Verify ffmpeg exists
        if [ ! -f ffmpeg ]; then
          echo "ERROR: ffmpeg binary not found after extraction"
          ls -la
          exit 1
        fi
        
        chmod +x ffmpeg
        
        # Remove quarantine attribute and code-sign
        xattr -dr com.apple.quarantine ffmpeg 2>/dev/null || true
        codesign -s - ffmpeg 2>/dev/null || true
        
        echo "ffmpeg ready:"
        ls -la ffmpeg
        ./ffmpeg -version | head -5
        cd ..
    
    - name: Stage native binaries for bundling
      run: |
        echo "=== Staging native binaries ==="
        mkdir -p native_libs
        
        BREW_PREFIX=$(brew --prefix)
        
        # Add rubberband binary (ffmpeg is already in native_bins)
        cp "$BREW_PREFIX/bin/rubberband" native_bins/
        
        echo "Staged executables:"
        ls -la native_bins/
        
        # Function to copy library and its dependencies
        copy_lib_with_deps() {
          local lib="$1"
          if [ -f "$lib" ]; then
            local basename=$(basename "$lib")
            # Skip X11 libraries
            if [[ ! "$basename" =~ ^lib[Xx](11|cb|au|dmcp|ext|render|fixes|cursor|i\.|randr|inerama) ]]; then
              cp -n "$lib" native_libs/ 2>/dev/null || true
            fi
          fi
        }
        
        # Copy core audio libraries for rubberband
        for pattern in librubberband libsndfile libsamplerate libFLAC libogg libvorbis libopus libmp3lame libfftw; do
          for lib in "$BREW_PREFIX"/lib/${pattern}*.dylib; do
            copy_lib_with_deps "$lib"
          done
        done
        
        # Get dependencies of rubberband only (ffmpeg is static, no deps)
        for bin in native_bins/rubberband; do
          if [ -f "$bin" ]; then
            for dep in $(otool -L "$bin" 2>/dev/null | grep -E "$BREW_PREFIX" | awk '{print $1}'); do
              copy_lib_with_deps "$dep"
              # Also get transitive dependencies
              for subdep in $(otool -L "$dep" 2>/dev/null | grep -E "$BREW_PREFIX" | awk '{print $1}'); do
                copy_lib_with_deps "$subdep"
              done
            done
          fi
        done
        
        echo "Staged libraries:"
        ls -la native_libs/ || echo "No libraries staged"
    
    - name: Patch install names for relocatable binaries
      run: |
        echo "=== Patching install names ==="
        
        # Patch dylibs to use @loader_path
        for lib in native_libs/*.dylib; do
          if [ -f "$lib" ]; then
            basename=$(basename "$lib")
            
            # Change the library's own ID
            install_name_tool -id "@loader_path/$basename" "$lib" 2>/dev/null || true
            
            # Change references to other Homebrew libs
            for dep in $(otool -L "$lib" 2>/dev/null | grep -E '/opt/homebrew|/usr/local' | awk '{print $1}'); do
              depbase=$(basename "$dep")
              install_name_tool -change "$dep" "@loader_path/$depbase" "$lib" 2>/dev/null || true
            done
          fi
        done
        
        # Patch executables
        for bin in native_bins/*; do
          if [ -f "$bin" ]; then
            for dep in $(otool -L "$bin" 2>/dev/null | grep -E '/opt/homebrew|/usr/local' | awk '{print $1}'); do
              depbase=$(basename "$dep")
              install_name_tool -change "$dep" "@executable_path/$depbase" "$bin" 2>/dev/null || true
            done
          fi
        done
        
        echo "Install name patching complete"
    
    - name: Build macOS app with PyInstaller
      run: |
        echo "=== Building with PyInstaller ==="
        # Just run pyinstaller with the spec file - no extra flags
        pyinstaller raptur.spec
        
        echo "Build complete. App structure:"
        ls -la dist/
        ls -la dist/Raptur.app/Contents/ || true
        ls -la dist/Raptur.app/Contents/MacOS/ | head -20 || true
    
    - name: Copy staged libraries into app bundle
      run: |
        echo "=== Copying libraries to app bundle ==="
        
        # Copy dylibs to MacOS directory (same as executables)
        if [ -d "native_libs" ] && [ "$(ls -A native_libs 2>/dev/null)" ]; then
          cp native_libs/*.dylib dist/Raptur.app/Contents/MacOS/ 2>/dev/null || true
          echo "Copied libraries to Contents/MacOS/"
        fi
        
        # Also create Frameworks directory as fallback
        mkdir -p dist/Raptur.app/Contents/Frameworks
        if [ -d "native_libs" ] && [ "$(ls -A native_libs 2>/dev/null)" ]; then
          cp native_libs/*.dylib dist/Raptur.app/Contents/Frameworks/ 2>/dev/null || true
          echo "Copied libraries to Contents/Frameworks/"
        fi
        
        echo "Final MacOS directory contents:"
        ls -la dist/Raptur.app/Contents/MacOS/ | head -30
    
    - name: Ad-hoc code sign the app
      run: |
        echo "=== Code signing ==="
        
        # Remove any existing signatures first
        codesign --remove-signature dist/Raptur.app 2>/dev/null || true
        
        # Sign all dylibs
        find dist/Raptur.app -name "*.dylib" -exec codesign --force --sign - {} \; 2>/dev/null || true
        echo "Signed dylibs"
        
        # Sign all .so files
        find dist/Raptur.app -name "*.so" -exec codesign --force --sign - {} \; 2>/dev/null || true
        echo "Signed .so files"
        
        # Sign executables in MacOS directory
        for exe in dist/Raptur.app/Contents/MacOS/*; do
          if [ -f "$exe" ] && [ -x "$exe" ]; then
            codesign --force --sign - "$exe" 2>/dev/null || true
          fi
        done
        echo "Signed executables"
        
        # Sign the main app bundle
        codesign --force --deep --sign - dist/Raptur.app
        echo "Signed app bundle"
        
        # Verify
        codesign --verify --verbose dist/Raptur.app && echo "Code signature verified!" || echo "Code signature verification failed (may still work)"
    
    - name: Create distribution zip
      run: |
        cd dist
        zip -r Raptur-macOS.zip Raptur.app
        mv Raptur-macOS.zip ../
        echo "Created Raptur-macOS.zip"
        ls -lh ../Raptur-macOS.zip
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: Raptur-macOS
        path: Raptur-macOS.zip
        retention-days: 30
